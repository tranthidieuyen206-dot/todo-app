<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Todo System Level 3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .done-text { 
            text-decoration: line-through; 
            color: #adb5bd; 
        }

        body {
            background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
        }

        .card-task {
            transition: 0.2s ease;
            border-radius: 12px;
        }

        .card-task:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        .progress {
            border-radius: 20px;
        }

        .progress-bar {
            font-weight: 500;
        }
    </style>
</head>

<body class="p-4">

<div class="container bg-white shadow-lg p-4 rounded-4" style="max-width: 900px;">

    <h2 class="text-center text-primary fw-bold mb-4">
        QU·∫¢N L√ù C√îNG VI·ªÜC
    </h2>

    <!-- User Info -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            Xin ch√†o: 
            <b class="text-dark"><%= currentUser.fullName %></b> 
            <span class="badge bg-secondary ms-1"><%= currentUser.role %></span>
        </div>
        <a href="/logout" class="btn btn-sm btn-outline-danger">
            Logout
        </a>
    </div>

    <!-- Progress -->
    <div class="mb-4">
        <label class="fw-bold mb-2">
            Ti·∫øn ƒë·ªô ho√†n th√†nh: <%= progress %>%
        </label>
        <div class="progress" style="height: 25px;">
            <div class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                 style="width: <%= progress %>%">
                <%= progress %>%
            </div>
        </div>
    </div>

    <!-- Form th√™m task (Admin Only) -->
    <% if(currentUser.role === 'admin') { %>
        <div class="card shadow-sm border-0 p-4 mb-4 bg-light rounded-4">
            <h5 class="mb-3 text-primary fw-semibold">T·∫°o c√¥ng vi·ªác m·ªõi</h5>

            <form action="/tasks/add" method="POST">
                
                <input type="text" 
                       name="title" 
                       class="form-control form-control-lg mb-3" 
                       placeholder="Nh·∫≠p t√™n c√¥ng vi·ªác..." 
                       required>

                <label class="fw-bold small mb-2">
                    Ph√¢n c√¥ng cho:
                </label>

                <div class="bg-white border rounded-3 p-3 mb-3"
                     style="max-height: 150px; overflow-y: auto;">
                    
                    <% users.forEach(u => { %>
                        <div class="form-check mb-1">
                            <input class="form-check-input"
                                   type="checkbox"
                                   name="assignedUsers"
                                   value="<%= u._id %>">
                            <label class="form-check-label">
                                <%= u.fullName %> 
                                <span class="text-muted">(<%= u.role %>)</span>
                            </label>
                        </div>
                    <% }) %>

                </div>

                <button type="submit" 
                        class="btn btn-primary w-100 btn-lg rounded-pill">
                    + TH√äM TASK
                </button>

            </form>
        </div>
    <% } %>

    <!-- Danh s√°ch task -->
    <ul class="list-group list-group-flush">
        <% tasks.forEach(task => { %>
            <li class="list-group-item card-task mb-3 border rounded-4 p-3">
                
                <div class="d-flex justify-content-between align-items-start">
                    
                    <div style="width: 70%;">
                        <h5 class="<%= task.isDone ? 'done-text' : '' %> fw-semibold">
                            <%= task.title %>
                        </h5>

                        <small class="text-muted d-block mb-2">
                            üë• Ph·ª• tr√°ch: 
                            <%= task.assignedUsers.map(u => u.fullName).join(', ') %>
                        </small>

                        <% if(task.isDone) { %>
                            <span class="badge bg-success">
                                ‚úî Ho√†n th√†nh l√∫c: 
                                <%= task.doneAt.toLocaleString('vi-VN') %>
                            </span>
                        <% } else { %>
                            <span class="badge bg-warning text-dark">
                                Ti·∫øn ƒë·ªô: 
                                <%= task.completedUsers.length %> /
                                <%= task.assignedUsers.length %>
                            </span>
                        <% } %>
                    </div>

                    <div class="d-flex flex-column gap-2">

                        <% if(!task.isDone) { %>
                            <form action="/tasks/complete/<%= task._id %>" 
                                  method="POST" 
                                  class="d-flex gap-2">

                                  <% if(!task.isDone && task.assignedUsers.some(u => u._id.toString() === currentUser.id)) { %>
                                    <form action="/tasks/complete/<%= task._id %>" method="POST">
                                        <button class="btn btn-sm btn-success">
                                            Xong
                                        </button>
                                    </form>
                                <% } %>
                        <% } %>

                        <form action="/tasks/delete/<%= task._id %>" method="POST">
                            <button class="btn btn-sm btn-outline-danger rounded-pill w-100">
                                X√≥a
                            </button>
                        </form>

                    </div>
                </div>

            </li>
        <% }) %>
    </ul>

</div>

</body>
</html>